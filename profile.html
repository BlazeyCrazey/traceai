<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - TraceAI</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="profile.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js"></script>
</head>
<body>
    <!-- Loading State -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <svg class="loader-spinner" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-dasharray="80 40"/>
            </svg>
            <p>Loading your profile...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="2" width="36" height="36" rx="8" stroke="currentColor" stroke-width="2"/>
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                    <circle cx="28" cy="12" r="3" fill="currentColor"/>
                    <circle cx="12" cy="28" r="3" fill="currentColor"/>
                    <circle cx="28" cy="28" r="3" fill="currentColor"/>
                    <path d="M12 12h16M12 28h16M12 12v16M28 12v16" stroke="currentColor" stroke-width="1.5"/>
                    <circle cx="20" cy="20" r="4" fill="currentColor"/>
                </svg>
                <span>TraceAI</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#">Features</a></li>
                <li><a href="#">Pricing</a></li>
                <li><a href="#">Docs</a></li>
            </ul>
            <div class="nav-buttons">
                <button class="btn btn-ghost" onclick="signOut()">Sign Out</button>
                <a href="profile.html" class="nav-avatar" id="navAvatar">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="User" id="navAvatarImg">
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="profile-page">
        <div class="profile-container">
            <!-- Profile Sidebar -->
            <aside class="profile-sidebar">
                <!-- User Info -->
                <div class="user-section">
                    <div class="user-avatar">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="User Avatar" id="sidebarAvatar">
                        <div class="avatar-badge online"></div>
                    </div>
                    <h2 class="user-name" id="userName">Loading...</h2>
                    <p class="user-email" id="userEmail">Loading...</p>
                </div>

                <!-- Plan Section -->
                <div class="plan-section">
                    <div class="plan-header">
                        <span class="plan-label">PLAN</span>
                    </div>
                    <div class="plan-info">
                        <div class="plan-name-row">
                            <span class="plan-name" id="planName">Free</span>
                            <span class="plan-badge" id="planBadge" style="display:none">TRIAL</span>
                        </div>
                        <p class="plan-expires" id="planStatus">Active</p>
                        <button class="btn btn-primary btn-upgrade" id="upgradeBtn">
                            <svg viewBox="0 0 20 20" fill="currentColor" class="btn-icon">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z"/>
                            </svg>
                            Upgrade Plan
                        </button>
                    </div>
                </div>

                <!-- Navigation Links -->
                <nav class="sidebar-nav">
                    <a href="#" class="sidebar-link active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        <span>Projects</span>
                        <span class="link-count">12</span>
                    </a>
                    <a href="#" class="sidebar-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
                        </svg>
                        <span>Libraries</span>
                        <span class="link-count">5</span>
                    </a>
                </nav>

                <!-- Social Links -->
                <div class="social-section">
                    <p class="social-label">Connected Accounts</p>
                    <div class="social-links">
                        <a href="#" class="social-link" id="sidebarYoutube" title="YouTube" target="_blank" rel="noopener" style="display:none">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                            </svg>
                        </a>
                        <a href="#" class="social-link" id="sidebarGithub" title="GitHub" target="_blank" rel="noopener" style="display:none">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        <a href="#" class="social-link" id="sidebarWebsite" title="Website" style="display:none" onclick="return handleWebsiteClick(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                        </a>
                    </div>
                </div>

                <!-- Edit Profile Button -->
                <button class="btn btn-outline btn-edit-profile" onclick="openEditModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Edit Profile
                </button>
            </aside>

            <!-- Main Content Area -->
            <div class="profile-main">
                <div class="content-header">
                    <h1>My Projects</h1>
                    <button class="btn btn-primary" onclick="openNewProjectModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New Project
                    </button>
                </div>

                <!-- Projects Grid (dynamically populated) -->
                <div class="projects-grid" id="projectsGrid"></div>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Avatar Upload -->
                <div class="form-group avatar-upload">
                    <div class="avatar-preview">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=TraceUser" alt="Avatar" id="avatarPreview">
                        <button class="avatar-edit-btn" onclick="document.getElementById('avatarInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                        </button>
                        <input type="file" id="avatarInput" accept="image/*" hidden onchange="previewAvatar(event)">
                    </div>
                    <p class="avatar-hint">Click to upload a new avatar</p>
                </div>

                <!-- Name -->
                <div class="form-group">
                    <label for="editName">Display Name</label>
                    <input type="text" id="editName" class="form-input" value="" placeholder="Your name">
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="editEmail">Email Address</label>
                    <input type="email" id="editEmail" class="form-input" value="" placeholder="your@email.com" disabled>
                    <p class="form-hint">Email cannot be changed</p>
                </div>

                <!-- Bio -->
                <div class="form-group">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" class="form-input form-textarea" placeholder="Tell us about yourself..." rows="3"></textarea>
                </div>

                <!-- Social Links -->
                <div class="form-group">
                    <label>Social Links</label>
                    <div class="social-inputs">
                        <div class="social-input-row">
                            <span class="social-input-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                            </span>
                            <input type="text" id="editYoutube" class="form-input" placeholder="YouTube username">
                            <span class="input-hint">youtube.com/@username</span>
                        </div>
                        <div class="social-input-row">
                            <span class="social-input-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                            </span>
                            <input type="text" id="editGithub" class="form-input" placeholder="GitHub username">
                            <span class="input-hint">github.com/username</span>
                        </div>
                        <div class="social-input-row">
                            <span class="social-input-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </span>
                            <input type="url" id="editWebsite" class="form-input" placeholder="https://yoursite.com">
                            <span class="input-hint">Full URL</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>New Project</h2>
                <button class="modal-close" onclick="closeNewProjectModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProjectName">Project Name</label>
                    <input type="text" id="newProjectName" class="form-input" placeholder="My PCB Project" required>
                </div>
                <div class="form-group">
                    <label for="newProjectDesc">Description <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
                    <textarea id="newProjectDesc" class="form-input form-textarea" placeholder="A brief description of your project..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeNewProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Rename Project Modal -->
    <div class="modal-overlay" id="renameProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Rename Project</h2>
                <button class="modal-close" onclick="closeRenameModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="renameProjectName">Project Name</label>
                    <input type="text" id="renameProjectName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="renameProjectDesc">Description <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
                    <textarea id="renameProjectDesc" class="form-input form-textarea" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeRenameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="renameProject()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="deleteProjectModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-header">
                <h2>Delete Project</h2>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-secondary);line-height:1.6">Delete <strong id="deleteProjectName"></strong>? This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="deleteProjectConfirmed()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" onclick="contextRename()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Rename
        </button>
        <button class="context-menu-item context-menu-danger" onclick="contextDelete()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            Delete
        </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="toast-icon">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
            <polyline points="22,4 12,14.01 9,11.01"/>
        </svg>
        <span class="toast-message">Profile updated successfully!</span>
    </div>

    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Global state
        let currentUser = null;
        let currentProfile = null;
        let selectedAvatarFile = null;
        let projectsList = [];
        let contextProjectId = null;
        let renameProjectId = null;
        let deleteProjectId = null;

        // Initialize page
        (async function init() {
            // Check authentication
            const session = await requireAuth();
            if (!session) return;

            currentUser = session.user;

            // Load profile data and projects in parallel
            await Promise.all([loadProfile(), loadProjects()]);

            // Hide loader
            document.getElementById('pageLoader').style.display = 'none';
        })();

        // Extract best display name from OAuth metadata
        function getOAuthDisplayName(user) {
            const meta = user.user_metadata || {};
            return meta.full_name || meta.name || meta.display_name || meta.user_name || meta.preferred_username || user.email.split('@')[0];
        }

        // Extract best avatar URL from OAuth metadata
        function getOAuthAvatarUrl(user) {
            const meta = user.user_metadata || {};
            return meta.avatar_url || meta.picture || null;
        }

        // Load user profile
        async function loadProfile() {
            const oauthName = getOAuthDisplayName(currentUser);
            const oauthAvatar = getOAuthAvatarUrl(currentUser);

            const { data: profile, error } = await getProfile(currentUser.id);

            if (error || !profile) {
                // Create profile if it doesn't exist
                const { data: created } = await createProfile(
                    currentUser.id,
                    oauthName,
                    currentUser.email,
                    oauthAvatar
                );
                currentProfile = created || null;
                // Fallback retry if upsert didn't return data
                if (!currentProfile) {
                    const retry = await getProfile(currentUser.id);
                    if (retry.data) currentProfile = retry.data;
                }
            } else {
                currentProfile = profile;

                // Sync OAuth avatar/name if profile still has defaults
                const isDicebear = currentProfile.avatar_url && currentProfile.avatar_url.includes('dicebear.com');
                const updates = {};

                if (isDicebear && oauthAvatar) {
                    updates.avatar_url = oauthAvatar;
                }
                if ((!currentProfile.display_name || currentProfile.display_name === currentUser.email.split('@')[0]) && oauthName !== currentUser.email.split('@')[0]) {
                    updates.display_name = oauthName;
                }

                if (Object.keys(updates).length > 0) {
                    const { data: updated } = await updateProfile(currentUser.id, updates);
                    if (updated) currentProfile = updated;
                    else currentProfile = { ...currentProfile, ...updates };
                }
            }

            // Update UI with profile data
            updateUI();
        }

        // Update UI with current profile data
        function updateUI() {
            if (!currentProfile) return;

            const avatarUrl = currentProfile.avatar_url || getOAuthAvatarUrl(currentUser) || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.email}`;

            // Update avatars
            document.getElementById('sidebarAvatar').src = avatarUrl;
            document.getElementById('navAvatarImg').src = avatarUrl;
            document.getElementById('avatarPreview').src = avatarUrl;

            // Update user info
            document.getElementById('userName').textContent = currentProfile.display_name || 'User';

            // Get auth provider (prioritize OAuth over email)
            let provider = 'email';
            const providers = currentUser.app_metadata?.providers || [];
            // Find OAuth provider (anything that's not 'email')
            const oauthProvider = providers.find(p => p !== 'email');
            if (oauthProvider) {
                provider = oauthProvider;
            } else if (providers.length > 0) {
                provider = providers[0];
            }
            const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
            const email = currentProfile.email || currentUser.email;
            document.getElementById('userEmail').textContent = `${providerName}: ${email}`;

            // Update plan info
            const planName = currentProfile.plan || 'free';
            const planStatus = currentProfile.plan_status || 'active';

            document.getElementById('planName').textContent = planName.charAt(0).toUpperCase() + planName.slice(1);

            const planBadge = document.getElementById('planBadge');
            if (planStatus === 'trial') {
                planBadge.style.display = 'inline-block';
                planBadge.textContent = 'TRIAL';
                planBadge.className = 'plan-badge trial';
            } else if (planStatus === 'active' && planName !== 'free') {
                planBadge.style.display = 'inline-block';
                planBadge.textContent = 'ACTIVE';
                planBadge.className = 'plan-badge active';
            } else {
                planBadge.style.display = 'none';
            }

            document.getElementById('planStatus').textContent = planStatus === 'trial' ?
                `${currentProfile.trial_days_remaining || 14} days remaining` :
                (planName === 'free' ? 'Free forever' : 'Active subscription');

            // Update edit modal fields
            document.getElementById('editName').value = currentProfile.display_name || '';
            document.getElementById('editEmail').value = currentProfile.email || currentUser.email;
            document.getElementById('editBio').value = currentProfile.bio || '';

            // Update social links in modal (usernames only)
            document.getElementById('editYoutube').value = currentProfile.youtube_url || '';
            document.getElementById('editGithub').value = currentProfile.github_url || '';
            document.getElementById('editWebsite').value = currentProfile.website_url || '';

            // Update sidebar social links (show/hide based on whether set)
            const ytLink = document.getElementById('sidebarYoutube');
            const ghLink = document.getElementById('sidebarGithub');
            const webLink = document.getElementById('sidebarWebsite');

            if (currentProfile.youtube_url) {
                ytLink.href = `https://youtube.com/@${currentProfile.youtube_url}`;
                ytLink.style.display = 'flex';
            } else {
                ytLink.style.display = 'none';
            }

            if (currentProfile.github_url) {
                ghLink.href = `https://github.com/${currentProfile.github_url}`;
                ghLink.style.display = 'flex';
            } else {
                ghLink.style.display = 'none';
            }

            if (currentProfile.website_url) {
                let siteUrl = currentProfile.website_url;
                if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//i.test(siteUrl)) {
                    siteUrl = 'https://' + siteUrl;
                }
                webLink.href = siteUrl;
                webLink.style.display = 'flex';
            } else {
                webLink.style.display = 'none';
            }
        }

        // Modal Functions
        function openEditModal() {
            // Reset form with current data
            updateUI();
            selectedAvatarFile = null;
            document.getElementById('editModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on overlay click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
                closeNewProjectModal();
                closeRenameModal();
                closeDeleteModal();
                closeContextMenu();
            }
        });

        // Avatar Preview
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                selectedAvatarFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Save Profile to Supabase
        async function saveProfile() {
            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn-loader"><svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="30 70"/></svg></span> Saving...';

            try {
                // Upload avatar if selected
                let newAvatarUrl = null;
                if (selectedAvatarFile) {
                    const { url, error: uploadError } = await uploadAvatar(currentUser.id, selectedAvatarFile);
                    if (uploadError) {
                        console.error('Avatar upload failed:', uploadError);
                        showToast('Failed to upload avatar', 'error');
                    } else {
                        newAvatarUrl = url;
                    }
                }

                // Get form values (youtube/github store usernames, website stores full URL)
                const ytUser = document.getElementById('editYoutube').value.trim().replace(/^@/, '');
                const ghUser = document.getElementById('editGithub').value.trim();
                const webUrl = document.getElementById('editWebsite').value.trim();

                const updates = {
                    display_name: document.getElementById('editName').value,
                    bio: document.getElementById('editBio').value,
                    youtube_url: ytUser || null,
                    github_url: ghUser || null,
                    website_url: webUrl || null
                };

                // Update profile in database (skip if only avatar changed, since uploadAvatar already saved it)
                const { data, error } = await updateProfile(currentUser.id, updates);

                if (error) {
                    throw error;
                }

                // Merge everything: DB response + avatar if newly uploaded
                if (data) {
                    currentProfile = data;
                } else {
                    currentProfile = { ...currentProfile, ...updates };
                }
                if (newAvatarUrl) {
                    currentProfile.avatar_url = newAvatarUrl;
                }

                updateUI();
                closeEditModal();
                showToast('Profile updated successfully!', 'success');

            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save profile: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Save Changes';
            }
        }

        // Website link warning
        function handleWebsiteClick(event) {
            event.preventDefault();
            const url = document.getElementById('sidebarWebsite').href;
            if (!url || url === '#') return false;

            const proceed = confirm(
                'WARNING: This user\'s personal website URL can be ANY site. ' +
                'This can also include viruses or malware.\n\n' +
                'LINK: ' + url
            );
            if (proceed) {
                window.open(url, '_blank', 'noopener,noreferrer');
            }
            return false;
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('.toast-icon');

            toast.querySelector('.toast-message').textContent = message;

            if (type === 'error') {
                toast.style.borderColor = 'var(--error)';
                icon.style.color = 'var(--error)';
            } else {
                toast.style.borderColor = 'var(--success)';
                icon.style.color = 'var(--success)';
            }

            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        // ===== Project Management =====

        // Time ago helper
        function timeAgo(date) {
            const now = new Date();
            const past = new Date(date);
            const seconds = Math.floor((now - past) / 1000);

            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return days === 1 ? '1 day ago' : `${days} days ago`;
            const weeks = Math.floor(days / 7);
            if (weeks < 5) return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
            const months = Math.floor(days / 30);
            if (months < 12) return months === 1 ? '1 month ago' : `${months} months ago`;
            const years = Math.floor(days / 365);
            return years === 1 ? '1 year ago' : `${years} years ago`;
        }

        // Load projects from DB
        async function loadProjects() {
            const { data, error } = await getProjects(currentUser.id);
            if (error) {
                console.error('Failed to load projects:', error);
                projectsList = [];
            } else {
                projectsList = data || [];
            }
            renderProjects(projectsList);
            updateProjectCount(projectsList.length);
        }

        // Update sidebar project count
        function updateProjectCount(count) {
            const countEl = document.querySelector('.sidebar-link.active .link-count');
            if (countEl) countEl.textContent = count;
        }

        // Render project cards
        function renderProjects(projects) {
            const grid = document.getElementById('projectsGrid');

            if (projects.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:var(--text-muted);margin-bottom:16px">
                            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
                        </svg>
                        <h3 style="margin-bottom:8px;color:var(--text-secondary)">No projects yet</h3>
                        <p style="color:var(--text-muted);margin-bottom:24px">Create your first project to get started.</p>
                        <button class="btn btn-primary" onclick="openNewProjectModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Create Project
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';

            projects.forEach(project => {
                // Generate a simple deterministic SVG preview based on project id
                const seed = project.id ? project.id.charCodeAt(0) + (project.id.charCodeAt(1) || 0) : 42;
                const cx1 = 30 + (seed % 40);
                const cy1 = 30 + (seed % 30);
                const cx2 = 120 + (seed % 50);
                const cy2 = 50 + (seed % 40);

                html += `
                    <div class="project-card" ondblclick="openProject('${project.id}')">
                        <div class="project-preview" onclick="openProject('${project.id}')" style="cursor:pointer">
                            <svg viewBox="0 0 200 120" class="pcb-thumbnail">
                                <rect x="5" y="5" width="190" height="110" rx="4" fill="#1a472a" stroke="#2d5a3d"/>
                                <path d="M${cx1} ${cy1} H${cx1 + 40} V${cy1 + 30} H${cx2}" stroke="#c9a227" stroke-width="2" fill="none"/>
                                <circle cx="${cx1}" cy="${cy1}" r="4" fill="#c9a227"/>
                                <circle cx="${cx2}" cy="${cy2}" r="4" fill="#c9a227"/>
                                <rect x="${cx2 - 8}" y="${cy2 - 8}" width="16" height="16" rx="2" fill="#2a2a2a" stroke="#555"/>
                            </svg>
                        </div>
                        <div class="project-info" onclick="openProject('${project.id}')" style="cursor:pointer">
                            <h3>${escapeHtml(project.name)}</h3>
                            <p>Modified ${timeAgo(project.updated_at)}</p>
                        </div>
                        <div class="project-actions">
                            <button class="action-btn" title="Open" onclick="openProject('${project.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                                    <polyline points="15,3 21,3 21,9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                            </button>
                            <button class="action-btn" title="More" onclick="toggleContextMenu(event, '${project.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"/>
                                    <circle cx="19" cy="12" r="1"/>
                                    <circle cx="5" cy="12" r="1"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });

            // New Project card at the end
            html += `
                <div class="project-card new-project" onclick="openNewProjectModal()">
                    <div class="new-project-content">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span>New Project</span>
                    </div>
                </div>
            `;

            grid.innerHTML = html;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open project (placeholder - will navigate to editor later)
        function openProject(id) {
            window.location.href = `editor.html?id=${id}`;
        }

        // ===== New Project Modal =====
        function openNewProjectModal() {
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDesc').value = '';
            document.getElementById('newProjectModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('newProjectName').focus(), 100);
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('newProjectModal').addEventListener('click', function(e) {
            if (e.target === this) closeNewProjectModal();
        });

        async function createNewProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const desc = document.getElementById('newProjectDesc').value.trim();

            if (!name) {
                document.getElementById('newProjectName').focus();
                return;
            }

            const btn = document.querySelector('#newProjectModal .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const { data, error } = await createProject(currentUser.id, name, desc);

            if (error) {
                showToast('Failed to create project: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Create Project';
                return;
            }

            closeNewProjectModal();
            showToast('Project created!', 'success');
            await loadProjects();
            btn.disabled = false;
            btn.textContent = 'Create Project';
        }

        // ===== Rename Project Modal =====
        function openRenameModal(id) {
            renameProjectId = id;
            const project = projectsList.find(p => p.id === id);
            if (!project) return;

            document.getElementById('renameProjectName').value = project.name || '';
            document.getElementById('renameProjectDesc').value = project.description || '';
            document.getElementById('renameProjectModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('renameProjectName').focus(), 100);
        }

        function closeRenameModal() {
            document.getElementById('renameProjectModal').classList.remove('active');
            document.body.style.overflow = '';
            renameProjectId = null;
        }

        document.getElementById('renameProjectModal').addEventListener('click', function(e) {
            if (e.target === this) closeRenameModal();
        });

        async function renameProject() {
            if (!renameProjectId) return;

            const name = document.getElementById('renameProjectName').value.trim();
            const desc = document.getElementById('renameProjectDesc').value.trim();

            if (!name) {
                document.getElementById('renameProjectName').focus();
                return;
            }

            const btn = document.querySelector('#renameProjectModal .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const { data, error } = await updateProject(renameProjectId, {
                name: name,
                description: desc || null
            });

            if (error) {
                showToast('Failed to rename project: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Save Changes';
                return;
            }

            closeRenameModal();
            showToast('Project updated!', 'success');
            await loadProjects();
            btn.disabled = false;
            btn.textContent = 'Save Changes';
        }

        // ===== Delete Project Modal =====
        function confirmDeleteProject(id) {
            deleteProjectId = id;
            const project = projectsList.find(p => p.id === id);
            if (!project) return;

            document.getElementById('deleteProjectName').textContent = project.name;
            document.getElementById('deleteProjectModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteModal() {
            document.getElementById('deleteProjectModal').classList.remove('active');
            document.body.style.overflow = '';
            deleteProjectId = null;
        }

        document.getElementById('deleteProjectModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });

        async function deleteProjectConfirmed() {
            if (!deleteProjectId) return;

            const btn = document.querySelector('#deleteProjectModal .btn-danger');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            const { error } = await deleteProject(deleteProjectId);

            if (error) {
                showToast('Failed to delete project: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Delete';
                return;
            }

            closeDeleteModal();
            showToast('Project deleted', 'success');
            await loadProjects();
            btn.disabled = false;
            btn.textContent = 'Delete';
        }

        // ===== Context Menu =====
        function toggleContextMenu(event, id) {
            event.stopPropagation();
            contextProjectId = id;
            const menu = document.getElementById('contextMenu');
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();

            menu.style.top = (rect.bottom + 4) + 'px';
            menu.style.left = (rect.left) + 'px';
            menu.classList.add('active');

            // Close on next outside click
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
            }, 0);
        }

        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        function contextRename() {
            closeContextMenu();
            if (contextProjectId) openRenameModal(contextProjectId);
        }

        function contextDelete() {
            closeContextMenu();
            if (contextProjectId) confirmDeleteProject(contextProjectId);
        }
    </script>
</body>
</html>
